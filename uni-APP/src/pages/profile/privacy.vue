<template>
  <view class="privacy-page">
    <!-- å¯¼èˆªæ  -->
    <view class="navbar">
      <view class="navbar-left" @tap="goBack">
        <app-icon name="arrow-left" size="lg" color="#333"></app-icon>
      </view>
      <view class="navbar-title">è´¦å·ä¸éšç§è®¾ç½®</view>
      <view class="navbar-right"></view>
    </view>
    
    <!-- å†…å®¹åŒº -->
    <view class="privacy-content">
      <!-- åŒ¿åä¸éšç§ -->
      <view class="privacy-section">
        <view class="section-title">åŒ¿åä¸éšç§</view>
        <view class="section-desc">ä¿æŠ¤æ‚¨çš„èº«ä»½å’Œéšç§ä¿¡æ¯</view>

        <view class="privacy-item highlight-item" :class="{ 'active-setting': privacySettings.anonymousMode }">
          <view class="item-info">
            <text class="item-title">åŒ¿åæ¨¡å¼</text>
            <text class="item-desc">å¼€å¯åæ‚¨çš„å‘å¸–å’Œè¯„è®ºå°†æ˜¾ç¤ºä¸ºåŒ¿åç”¨æˆ·</text>
          </view>
          <switch
            :checked="privacySettings.anonymousMode"
            @change="handleSwitchChange('anonymousMode', $event)"
            color="#5B8EF9"
          />
        </view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">å…è®¸è¢«æœç´¢</text>
            <text class="item-desc">å…è®¸å…¶ä»–ç”¨æˆ·é€šè¿‡æœç´¢æ‰¾åˆ°æ‚¨</text>
          </view>
          <switch
            :checked="privacySettings.allowSearch"
            @change="handleSwitchChange('allowSearch', $event)"
            color="#5B8EF9"
          />
        </view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">æ˜¾ç¤ºä½ç½®ä¿¡æ¯</text>
            <text class="item-desc">åœ¨åŠ¨æ€ä¸­æ˜¾ç¤ºæ‚¨çš„ä½ç½®ä¿¡æ¯</text>
          </view>
          <switch
            :checked="privacySettings.showLocation"
            @change="handleSwitchChange('showLocation', $event)"
            color="#5B8EF9"
          />
        </view>
      </view>

      <!-- äº’åŠ¨æƒé™ -->
      <view class="privacy-section">
        <view class="section-title">äº’åŠ¨æƒé™</view>
        <view class="section-desc">è®¾ç½®å…¶ä»–ç”¨æˆ·ä¸æ‚¨çš„äº’åŠ¨æƒé™</view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">å…è®¸å…³æ³¨</text>
            <text class="item-desc">å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥å…³æ³¨æ‚¨</text>
          </view>
          <switch
            :checked="privacySettings.allowFollow"
            @change="handleSwitchChange('allowFollow', $event)"
            color="#5B8EF9"
          />
        </view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">å…è®¸è¯„è®º</text>
            <text class="item-desc">å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥è¯„è®ºæ‚¨çš„å¸–å­</text>
          </view>
          <switch
            :checked="privacySettings.allowComment"
            @change="handleSwitchChange('allowComment', $event)"
            color="#5B8EF9"
          />
        </view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">å…è®¸ç§ä¿¡</text>
            <text class="item-desc">å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥ç»™æ‚¨å‘é€ç§ä¿¡</text>
          </view>
          <switch
            :checked="privacySettings.allowMessage"
            @change="handleSwitchChange('allowMessage', $event)"
            color="#5B8EF9"
          />
        </view>
      </view>

      <!-- å†…å®¹å¯è§æ€§ -->
      <view class="privacy-section">
        <view class="section-title">å†…å®¹å¯è§æ€§</view>
        <view class="section-desc">è®¾ç½®æ‚¨çš„å†…å®¹å¯¹å…¶ä»–ç”¨æˆ·çš„å¯è§æ€§</view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">æˆ‘çš„æ”¶è—</text>
            <text class="item-desc">å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥çœ‹åˆ°æ‚¨çš„æ”¶è—åˆ—è¡¨</text>
          </view>
          <switch
            :checked="privacySettings.favoriteVisible"
            @change="handleSwitchChange('favoriteVisible', $event)"
            color="#5B8EF9"
          />
        </view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">å…³æ³¨åˆ—è¡¨</text>
            <text class="item-desc">å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥çœ‹åˆ°æ‚¨çš„å…³æ³¨åˆ—è¡¨</text>
          </view>
          <switch
            :checked="privacySettings.followListVisible"
            @change="handleSwitchChange('followListVisible', $event)"
            color="#5B8EF9"
          />
        </view>

        <view class="privacy-item">
          <view class="item-info">
            <text class="item-title">ç²‰ä¸åˆ—è¡¨</text>
            <text class="item-desc">å…¶ä»–ç”¨æˆ·æ˜¯å¦å¯ä»¥çœ‹åˆ°æ‚¨çš„ç²‰ä¸åˆ—è¡¨</text>
          </view>
          <switch
            :checked="privacySettings.fansListVisible"
            @change="handleSwitchChange('fansListVisible', $event)"
            color="#5B8EF9"
          />
        </view>
      </view>

      <!-- è´¦å·ç®¡ç† -->
      <view class="privacy-section">
        <view class="section-title">è´¦å·ç®¡ç†</view>
        <view class="section-desc">ç®¡ç†æ‚¨çš„è´¦å·ä¿¡æ¯å’Œå®‰å…¨è®¾ç½®</view>

        <view class="privacy-item clickable-item" @tap="changePassword">
          <view class="item-info">
            <text class="item-title">ä¿®æ”¹å¯†ç </text>
            <text class="item-desc">æ›´æ”¹æ‚¨çš„ç™»å½•å¯†ç </text>
          </view>
          <app-icon name="arrow-right" size="sm" color="#999"></app-icon>
        </view>

        <view class="privacy-item clickable-item" @tap="changePhone">
          <view class="item-info">
            <text class="item-title">æ›´æ¢æ‰‹æœºå·</text>
            <text class="item-desc">æ›´æ”¹ç»‘å®šçš„æ‰‹æœºå·ç </text>
          </view>
          <app-icon name="arrow-right" size="sm" color="#999"></app-icon>
        </view>

        <view class="privacy-item clickable-item" @tap="changeEmail">
          <view class="item-info">
            <text class="item-title">ç»‘å®šé‚®ç®±</text>
            <text class="item-desc">ç»‘å®šæˆ–æ›´æ”¹é‚®ç®±åœ°å€</text>
          </view>
          <app-icon name="arrow-right" size="sm" color="#999"></app-icon>
        </view>
      </view>

      <!-- å±é™©æ“ä½œ -->
      <view class="privacy-section danger-section">
        <view class="section-title danger-title">å±é™©æ“ä½œ</view>
        <view class="section-desc">è¯·è°¨æ…æ“ä½œï¼Œä»¥ä¸‹æ“ä½œä¸å¯æ¢å¤</view>

        <view class="privacy-item clickable-item danger-item" @tap="logoutAccount">
          <view class="item-info">
            <text class="item-title danger-text">é€€å‡ºç™»å½•</text>
            <text class="item-desc">é€€å‡ºå½“å‰è´¦å·</text>
          </view>
          <app-icon name="arrow-right" size="sm" color="#ff4757"></app-icon>
        </view>

        <view class="privacy-item clickable-item danger-item" @tap="deleteAccount">
          <view class="item-info">
            <text class="item-title danger-text">æ³¨é”€è´¦å·</text>
            <text class="item-desc">æ°¸ä¹…åˆ é™¤è´¦å·åŠæ‰€æœ‰æ•°æ®</text>
          </view>
          <app-icon name="arrow-right" size="sm" color="#ff4757"></app-icon>
        </view>
      </view>

      <!-- éšç§æç¤º -->
      <view class="privacy-tips">
        <text class="tip-icon">ğŸ”’</text>
        <text class="tip-text">æˆ‘ä»¬é‡è§†æ‚¨çš„éšç§å’Œè´¦å·å®‰å…¨ï¼Œæ‰€æœ‰æ›´æ”¹å³æ—¶ç”Ÿæ•ˆ</text>
      </view>
    </view>
    

  </view>
</template>

<script>
import AppIcon from '@/components/common/AppIcon.vue';
import api from '@/api';

export default {
  name: 'PrivacyPage',
  components: {
    AppIcon
  },
  data() {
    return {
      saving: false,
      privacySettings: {
        // åŒ¿åä¸éšç§
        anonymousMode: false,
        allowSearch: true,
        showLocation: false,
        // äº’åŠ¨æƒé™
        allowFollow: true,
        allowComment: true,
        allowMessage: true,
        // å†…å®¹å¯è§æ€§
        favoriteVisible: false,
        followListVisible: true,
        fansListVisible: true
      }
    };
  },
  onLoad() {
    this.loadPrivacySettings();
  },
  methods: {
    // è¿”å›ä¸Šä¸€é¡µ
    goBack() {
      uni.navigateBack();
    },

    // åŠ è½½éšç§è®¾ç½®
    async loadPrivacySettings() {
      try {
        // ä»æœåŠ¡å™¨è·å–éšç§è®¾ç½®
        const response = await api.user.getPrivacySettings();
        if (response.code === 0 && response.data) {
          this.privacySettings = {
            ...this.privacySettings,
            ...response.data
          };
        }
      } catch (error) {
        console.error('è·å–éšç§è®¾ç½®å¤±è´¥:', error);

        // å¦‚æœAPIå¤±è´¥ï¼Œä»æœ¬åœ°å­˜å‚¨åŠ è½½åŒ¿åè®¾ç½®ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
        try {
          const anonymousMode = uni.getStorageSync('anonymousMode');
          if (anonymousMode !== '') {
            this.privacySettings.anonymousMode = anonymousMode === 'true';
          }
        } catch (e) {
          console.error('è¯»å–æœ¬åœ°åŒ¿åè®¾ç½®å¤±è´¥', e);
        }

        // æ˜¾ç¤ºé”™è¯¯æç¤º
        uni.showToast({
          title: 'åŠ è½½è®¾ç½®å¤±è´¥',
          icon: 'none',
          duration: 2000
        });
      }
    },

    // å¤„ç†å¼€å…³å˜åŒ–
    handleSwitchChange(key, event) {
      const newValue = event.detail.value;
      this.privacySettings[key] = newValue;

      // ç‰¹æ®Šå¤„ç†åŒ¿åæ¨¡å¼ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼ˆä¿æŒå…¼å®¹æ€§ï¼‰
      if (key === 'anonymousMode') {
        uni.setStorage({
          key: 'anonymousMode',
          data: String(newValue)
        });

        // æ·»åŠ éœ‡åŠ¨åé¦ˆ
        uni.vibrateShort({
          success: function () {

          }
        });
      }

      // å®æ—¶ä¿å­˜è®¾ç½®
      this.saveSettings();
    },

    // ä¿å­˜è®¾ç½®
    async saveSettings() {
      if (this.saving) return; // é˜²æ­¢é‡å¤æäº¤

      this.saving = true;

      try {
        // è°ƒç”¨APIä¿å­˜éšç§è®¾ç½®åˆ°æœåŠ¡å™¨
        const response = await api.user.updatePrivacySettings(this.privacySettings);

        if (response.code === 0) {
          uni.showToast({
            title: 'è®¾ç½®å·²ä¿å­˜',
            icon: 'success',
            duration: 2000
          });
        } else {
          throw new Error(response.msg || 'ä¿å­˜å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¿å­˜éšç§è®¾ç½®å¤±è´¥:', error);
        uni.showToast({
          title: error.message || 'ä¿å­˜å¤±è´¥',
          icon: 'none',
          duration: 2000
        });
      } finally {
        this.saving = false;
      }
    },

    // è´¦å·ç®¡ç†æ–¹æ³•
    changePassword() {
      uni.showToast({
        title: 'åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none',
        duration: 2000
      });
    },

    changePhone() {
      uni.showToast({
        title: 'åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none',
        duration: 2000
      });
    },

    changeEmail() {
      uni.showToast({
        title: 'åŠŸèƒ½å¼€å‘ä¸­',
        icon: 'none',
        duration: 2000
      });
    },

    logoutAccount() {
      uni.showModal({
        title: 'é€€å‡ºç™»å½•',
        content: 'ç¡®å®šè¦é€€å‡ºå½“å‰è´¦å·å—ï¼Ÿ',
        success: (res) => {
          if (res.confirm) {
            // æ¸…é™¤ç™»å½•çŠ¶æ€
            uni.removeStorageSync('token');
            uni.removeStorageSync('userInfo');

            // è·³è½¬åˆ°ç™»å½•é¡µ
            uni.reLaunch({
              url: '/pages/auth/login/index'
            });

            uni.showToast({
              title: 'å·²é€€å‡ºç™»å½•',
              icon: 'success',
              duration: 2000
            });
          }
        }
      });
    },

    deleteAccount() {
      uni.showModal({
        title: 'æ³¨é”€è´¦å·',
        content: 'æ³¨é”€åå°†æ°¸ä¹…åˆ é™¤æ‚¨çš„è´¦å·åŠæ‰€æœ‰æ•°æ®ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šè¦ç»§ç»­å—ï¼Ÿ',
        confirmColor: '#ff4757',
        success: (res) => {
          if (res.confirm) {
            uni.showModal({
              title: 'æœ€åç¡®è®¤',
              content: 'æ‚¨çœŸçš„è¦æ³¨é”€è´¦å·å—ï¼Ÿè¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼',
              confirmColor: '#ff4757',
              success: (res2) => {
                if (res2.confirm) {
                  uni.showToast({
                    title: 'åŠŸèƒ½å¼€å‘ä¸­',
                    icon: 'none',
                    duration: 2000
                  });
                }
              }
            });
          }
        }
      });
    }
  }
};
</script>

<style lang="scss" scoped>
@import '@/styles/variables.scss';
@import '@/styles/mixins.scss';

.privacy-page {
  min-height: 100vh;
  background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
}

/* å¯¼èˆªæ  */
.navbar {
  @include flex(row, space-between, center);
  height: 88rpx;
  padding: 0 30rpx;
  background: #ffffff;
  border-bottom: 2rpx solid #f0f0f0;
  position: sticky;
  top: 0;
  z-index: 100;
}

.navbar-left, .navbar-right {
  width: 80rpx;
  @include flex(row, center, center);
}

.navbar-title {
  font-size: $font-size-lg;
  font-weight: 600;
  color: $text-primary;
}

/* å†…å®¹åŒº */
.privacy-content {
  padding: 40rpx 30rpx;
}

.privacy-section {
  margin-bottom: 60rpx;
}

.section-title {
  font-size: $font-size-lg;
  font-weight: 600;
  color: $text-primary;
  margin-bottom: 16rpx;
}

.section-desc {
  font-size: $font-size-sm;
  color: $text-tertiary;
  margin-bottom: 40rpx;
}

.privacy-item {
  @include flex(row, space-between, center);
  padding: 32rpx 0;
  border-bottom: 2rpx solid #f5f5f5;
  
  &:last-child {
    border-bottom: none;
  }
}

.item-info {
  flex: 1;
}

.item-title {
  font-size: $font-size-md;
  color: $text-primary;
  font-weight: 500;
  display: block;
  margin-bottom: 8rpx;
}

.item-desc {
  font-size: $font-size-sm;
  color: $text-tertiary;
}

.item-value {
  @include flex(row, center, center);
  gap: 16rpx;
}

.value-text {
  font-size: $font-size-md;
  color: $text-secondary;
}

/* é«˜äº®é¡¹ç›® */
.highlight-item {
  background: linear-gradient(135deg, #f8fafc 0%, #e3f2fd 100%);
  border-radius: 16rpx;
  margin: 16rpx 0;
  padding: 24rpx 20rpx !important;
  border: 2rpx solid #e3f2fd;
}

.active-setting {
  background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
  border-color: #5B8EF9;
}

/* éšç§æç¤º */
.privacy-tips {
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #f3e5f5 0%, #e8f5e8 100%);
  border-radius: 16rpx;
  padding: 24rpx 30rpx;
  margin: 60rpx 0 120rpx 0;
  border: 2rpx solid #e8f5e8;
}

.tip-icon {
  font-size: 36rpx;
  margin-right: 20rpx;
}

.tip-text {
  font-size: $font-size-sm;
  color: $text-tertiary;
  line-height: 1.5;
  flex: 1;
}

/* å¯ç‚¹å‡»é¡¹ç›®æ ·å¼ */
.clickable-item {
  cursor: pointer;
  transition: background-color 0.2s ease;

  &:active {
    background-color: #f8f9fa;
  }
}

/* å±é™©æ“ä½œåŒºåŸŸæ ·å¼ */
.danger-section {
  .section-title.danger-title {
    color: #ff4757;
  }
}

.danger-item {
  border-left: 4rpx solid #ff4757;

  .danger-text {
    color: #ff4757 !important;
  }

  &:active {
    background-color: #fff5f5;
  }
}


</style>
