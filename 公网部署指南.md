# æ ¡å›­å¢™é¡¹ç›®å…¬ç½‘éƒ¨ç½²æŒ‡å—

## ğŸŒ æ¦‚è¿°

æœ¬æŒ‡å—å¸®åŠ©ä½ å°†æ ¡å›­å¢™åç«¯APIéƒ¨ç½²åˆ°å…¬ç½‘æœåŠ¡å™¨ï¼Œç¡®ä¿ç§»åŠ¨ç«¯åº”ç”¨èƒ½å¤Ÿæ­£å¸¸è®¿é—®åç«¯æ¥å£ã€‚

## ğŸ“‹ éƒ¨ç½²æ¶æ„

```
ç§»åŠ¨ç«¯APP/H5 â†’ å…¬ç½‘åŸŸå(HTTPS) â†’ äº‘æœåŠ¡å™¨ â†’ åç«¯API(3000ç«¯å£)
                                   â†“
                              MySQL + Redis
```

## 1. ğŸ–¥ï¸ äº‘æœåŠ¡å™¨é€‰æ‹©å’Œè´­ä¹°

### æ¨èçš„äº‘æœåŠ¡å•†

#### å›½å†…æœåŠ¡å•†
- **é˜¿é‡Œäº‘ECS**: ç¨³å®šå¯é ï¼Œæ–‡æ¡£é½å…¨
- **è…¾è®¯äº‘CVM**: æ€§ä»·æ¯”é«˜ï¼Œé€‚åˆä¸ªäººé¡¹ç›®
- **åä¸ºäº‘**: ä¼ä¸šçº§ç¨³å®šæ€§å¥½
- **ç™¾åº¦äº‘**: ä»·æ ¼ä¾¿å®œï¼Œé€‚åˆé¢„ç®—æœ‰é™

#### å›½å¤–æœåŠ¡å•†
- **AWS EC2**: å…¨çƒè¦†ç›–ï¼ŒæŠ€æœ¯å…ˆè¿›
- **Google Cloud**: ç½‘ç»œè´¨é‡å¥½
- **DigitalOcean**: ç®€å•æ˜“ç”¨ï¼Œä»·æ ¼é€æ˜
- **Vultr**: ä»·æ ¼ä¾¿å®œï¼Œå¤šåœ°åŒºå¯é€‰

### æœåŠ¡å™¨é…ç½®å»ºè®®

#### æœ€å°é…ç½®(é€‚åˆæµ‹è¯•)
- **CPU**: 1æ ¸
- **å†…å­˜**: 2GB
- **å­˜å‚¨**: 40GB SSD
- **å¸¦å®½**: 1Mbps
- **æœˆè´¹ç”¨**: Â¥50-100

#### æ¨èé…ç½®(é€‚åˆç”Ÿäº§)
- **CPU**: 2æ ¸
- **å†…å­˜**: 4GB  
- **å­˜å‚¨**: 80GB SSD
- **å¸¦å®½**: 3Mbps
- **æœˆè´¹ç”¨**: Â¥100-200

#### é«˜æ€§èƒ½é…ç½®(å¤§é‡ç”¨æˆ·)
- **CPU**: 4æ ¸
- **å†…å­˜**: 8GB
- **å­˜å‚¨**: 160GB SSD
- **å¸¦å®½**: 5Mbps
- **æœˆè´¹ç”¨**: Â¥300-500

### æ“ä½œç³»ç»Ÿé€‰æ‹©
æ¨èï¼š**Ubuntu 20.04 LTS** æˆ– **CentOS 7/8**

## 2. ğŸŒ åŸŸåæ³¨å†Œå’ŒDNSé…ç½®

### åŸŸåæ³¨å†Œ

#### å›½å†…åŸŸåæ³¨å†Œå•†
- **é˜¿é‡Œäº‘ä¸‡ç½‘**: https://wanwang.aliyun.com
- **è…¾è®¯äº‘**: https://dnspod.cloud.tencent.com
- **è¥¿éƒ¨æ•°ç **: https://www.west.cn

#### å›½å¤–åŸŸåæ³¨å†Œå•†  
- **GoDaddy**: https://www.godaddy.com
- **Namecheap**: https://www.namecheap.com
- **Cloudflare**: https://www.cloudflare.com

### æ¨èåŸŸåç»“æ„
```
ä¸»åŸŸå: your-domain.com
APIæ¥å£: api.your-domain.com
ç®¡ç†åå°: admin.your-domain.com
ç§»åŠ¨ç«¯H5: app.your-domain.com
```

### DNSè§£æé…ç½®

åœ¨åŸŸåæ³¨å†Œå•†æˆ–DNSæœåŠ¡å•†å¤„æ·»åŠ ä»¥ä¸‹è®°å½•ï¼š

```dns
ç±»å‹    ä¸»æœºè®°å½•    è®°å½•å€¼              TTL
A      @          æœåŠ¡å™¨å…¬ç½‘IP        600
A      api        æœåŠ¡å™¨å…¬ç½‘IP        600  
A      admin      æœåŠ¡å™¨å…¬ç½‘IP        600
A      app        æœåŠ¡å™¨å…¬ç½‘IP        600
CNAME  www        your-domain.com     600
```

## 3. ğŸ” æœåŠ¡å™¨åŸºç¡€é…ç½®

### è¿æ¥æœåŠ¡å™¨
```bash
# ä½¿ç”¨SSHè¿æ¥æœåŠ¡å™¨
ssh root@your-server-ip

# æˆ–ä½¿ç”¨å¯†é’¥æ–‡ä»¶
ssh -i your-key.pem ubuntu@your-server-ip
```

### æ›´æ–°ç³»ç»Ÿ
```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### åˆ›å»ºéƒ¨ç½²ç”¨æˆ·
```bash
# åˆ›å»ºç”¨æˆ·
sudo adduser deploy
sudo usermod -aG sudo deploy

# è®¾ç½®SSHå¯†é’¥ç™»å½•
su - deploy
mkdir ~/.ssh
chmod 700 ~/.ssh

# å°†ä½ çš„å…¬é’¥æ·»åŠ åˆ° ~/.ssh/authorized_keys
echo "your-public-key" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

### åŸºç¡€å®‰å…¨é…ç½®
```bash
# ä¿®æ”¹SSHç«¯å£(å¯é€‰)
sudo nano /etc/ssh/sshd_config
# Port 22 æ”¹ä¸º Port 2222

# ç¦ç”¨rootç™»å½•
# PermitRootLogin no

# é‡å¯SSHæœåŠ¡
sudo systemctl restart ssh

# é…ç½®é˜²ç«å¢™
sudo ufw allow 2222/tcp  # SSHç«¯å£
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

## 4. ğŸš€ éƒ¨ç½²åç«¯APIåˆ°å…¬ç½‘

### ä½¿ç”¨æˆ‘ä»¬çš„è‡ªåŠ¨åŒ–è„šæœ¬
```bash
# 1. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶åˆ°æœåŠ¡å™¨
scp -r campus-wall/ deploy@your-server-ip:/home/deploy/

# 2. è¿æ¥æœåŠ¡å™¨
ssh deploy@your-server-ip

# 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
cd campus-wall
chmod +x scripts/deploy.sh
./scripts/deploy.sh
```

### æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

#### 4.1 å®‰è£…ä¾èµ–ç¯å¢ƒ
```bash
# å®‰è£…Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…MySQL
sudo apt install mysql-server -y
sudo mysql_secure_installation

# å®‰è£…Redis
sudo apt install redis-server -y

# å®‰è£…Nginx
sudo apt install nginx -y

# å®‰è£…PM2
sudo npm install -g pm2
```

#### 4.2 é…ç½®æ•°æ®åº“
```bash
# åˆå§‹åŒ–æ•°æ®åº“
cd campus-wall
chmod +x scripts/init-database.sh
./scripts/init-database.sh
```

#### 4.3 é…ç½®åç«¯æœåŠ¡
```bash
cd server

# å®‰è£…ä¾èµ–
npm install --production

# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
nano .env
```

```env
NODE_ENV=production
PORT=3000

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_USER=campus_wall
DB_PASSWORD=your_secure_password
DB_NAME=campus_community

# Redisé…ç½®
REDIS_HOST=localhost
REDIS_PORT=6379

# JWTå¯†é’¥(é‡è¦ï¼šå¿…é¡»æ›´æ¢ä¸ºå¼ºå¯†é’¥)
JWT_SECRET=your_very_secure_jwt_secret_key_here

# è·¨åŸŸé…ç½®(å…è®¸ä½ çš„åŸŸå)
CORS_ORIGIN=https://api.your-domain.com,https://app.your-domain.com

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10485760
```

#### 4.4 å¯åŠ¨åç«¯æœåŠ¡
```bash
# è¿è¡Œæ•°æ®åº“è¿ç§»
npm run seed-data

# ä½¿ç”¨PM2å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js --env production

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status
```

## 5. ğŸ”§ Nginxåå‘ä»£ç†é…ç½®

### é…ç½®APIåŸŸå
```bash
sudo nano /etc/nginx/sites-available/api.your-domain.com
```

```nginx
server {
    listen 80;
    server_name api.your-domain.com;
    
    # é‡å®šå‘åˆ°HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.your-domain.com;
    
    # SSLè¯ä¹¦é…ç½®(åç»­ä¼šé…ç½®)
    ssl_certificate /etc/letsencrypt/live/api.your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.your-domain.com/privkey.pem;
    
    # åå‘ä»£ç†åˆ°åç«¯
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # CORSé…ç½®
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
        add_header Access-Control-Allow-Headers 'Accept, Authorization, Cache-Control, Content-Type, DNT, If-Modified-Since, Keep-Alive, Origin, User-Agent, X-Requested-With';
        
        # é¢„æ£€è¯·æ±‚å¤„ç†
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, OPTIONS';
            add_header Access-Control-Allow-Headers 'Accept, Authorization, Cache-Control, Content-Type, DNT, If-Modified-Since, Keep-Alive, Origin, User-Agent, X-Requested-With';
            add_header Access-Control-Max-Age 1728000;
            add_header Content-Type 'text/plain charset=UTF-8';
            add_header Content-Length 0;
            return 204;
        }
        
        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 50M;
    }
}
```

### å¯ç”¨ç«™ç‚¹é…ç½®
```bash
# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/api.your-domain.com /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯Nginx
sudo systemctl restart nginx
```

## 6. ğŸ”’ SSLè¯ä¹¦é…ç½®

### ä½¿ç”¨Let's Encryptå…è´¹è¯ä¹¦
```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx -y

# è·å–SSLè¯ä¹¦
sudo certbot --nginx -d api.your-domain.com

# è®¾ç½®è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œ
0 12 * * * /usr/bin/certbot renew --quiet
```

### éªŒè¯HTTPSè®¿é—®
```bash
# æµ‹è¯•APIæ¥å£
curl https://api.your-domain.com/api/health
```

## 7. ğŸ“± ç§»åŠ¨ç«¯é…ç½®ä¿®æ”¹

### ä¿®æ”¹APIåŸºç¡€åœ°å€

#### uni-APPé…ç½®
```javascript
// uni-APP/src/config/index.js
const config = {
  development: {
    baseURL: 'http://localhost:3000/api'
  },
  production: {
    baseURL: 'https://api.your-domain.com/api'  // ä¿®æ”¹ä¸ºä½ çš„åŸŸå
  }
}

export default config[process.env.NODE_ENV || 'development']
```

#### è¯·æ±‚é…ç½®
```javascript
// uni-APP/src/api/request.js
import config from '@/config'

const request = uni.request({
  baseURL: config.baseURL,
  timeout: 10000,
  header: {
    'Content-Type': 'application/json'
  }
})

export default request
```

### æ„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
cd uni-APP

# æ„å»ºH5ç‰ˆæœ¬
npm run build:h5

# æ„å»ºå¾®ä¿¡å°ç¨‹åº
npm run build:mp-weixin

# æ„å»ºAPP
npm run build:app-plus
```

## 8. ğŸ›¡ï¸ å®‰å…¨é…ç½®å’Œä¼˜åŒ–

### æœåŠ¡å™¨å®‰å…¨
```bash
# å®‰è£…fail2bané˜²æ­¢æš´åŠ›ç ´è§£
sudo apt install fail2ban -y

# é…ç½®fail2ban
sudo nano /etc/fail2ban/jail.local
```

```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = 2222
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
```

### æ•°æ®åº“å®‰å…¨
```bash
# ä¿®æ”¹MySQLé…ç½®
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf

# æ·»åŠ ä»¥ä¸‹é…ç½®
bind-address = 127.0.0.1  # åªå…è®¸æœ¬åœ°è¿æ¥
skip-networking = false
```

### åº”ç”¨å®‰å…¨é…ç½®

#### åç«¯å®‰å…¨ä¸­é—´ä»¶
```javascript
// server/src/app.js ä¸­å·²åŒ…å«çš„å®‰å…¨é…ç½®
app.use(helmet());  // å®‰å…¨å¤´
app.use(cors({       // è·¨åŸŸé…ç½®
  origin: process.env.CORS_ORIGIN?.split(',') || ['https://api.your-domain.com']
}));
app.use(rateLimit({  // è¯·æ±‚é™æµ
  windowMs: 15 * 60 * 1000, // 15åˆ†é’Ÿ
  max: 100 // æœ€å¤š100ä¸ªè¯·æ±‚
}));
```

### æ€§èƒ½ä¼˜åŒ–
```bash
# é…ç½®RedisæŒä¹…åŒ–
sudo nano /etc/redis/redis.conf

# å¯ç”¨AOFæŒä¹…åŒ–
appendonly yes
appendfsync everysec

# é‡å¯Redis
sudo systemctl restart redis
```

## 9. ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### è®¾ç½®ç›‘æ§è„šæœ¬
```bash
# åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬
nano ~/health-check.sh
```

```bash
#!/bin/bash
# å¥åº·æ£€æŸ¥è„šæœ¬

API_URL="https://api.your-domain.com/api/health"
LOG_FILE="/var/log/campus-wall-health.log"

# æ£€æŸ¥APIæ˜¯å¦å¯è®¿é—®
if curl -f -s "$API_URL" > /dev/null; then
    echo "$(date): APIå¥åº·æ£€æŸ¥æ­£å¸¸" >> "$LOG_FILE"
else
    echo "$(date): APIå¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå°è¯•é‡å¯æœåŠ¡" >> "$LOG_FILE"
    pm2 restart campus-wall-api
fi

# æ£€æŸ¥ç£ç›˜ç©ºé—´
DISK_USAGE=$(df / | awk 'NR==2 {print $5}' | sed 's/%//')
if [ "$DISK_USAGE" -gt 80 ]; then
    echo "$(date): ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå·²ä½¿ç”¨${DISK_USAGE}%" >> "$LOG_FILE"
fi
```

```bash
chmod +x ~/health-check.sh

# è®¾ç½®å®šæ—¶ä»»åŠ¡
crontab -e
# æ·»åŠ ï¼šæ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
*/5 * * * * /home/deploy/health-check.sh
```

### å¤‡ä»½ç­–ç•¥
```bash
# åˆ›å»ºè‡ªåŠ¨å¤‡ä»½è„šæœ¬
nano ~/backup.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/home/deploy/backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"

# å¤‡ä»½æ•°æ®åº“
mysqldump -u campus_wall -pæ ¡å›­å¢™123 campus_community > "$BACKUP_DIR/db_$DATE.sql"

# å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
tar -czf "$BACKUP_DIR/uploads_$DATE.tar.gz" /home/deploy/campus-wall/server/uploads

# æ¸…ç†30å¤©å‰çš„å¤‡ä»½
find "$BACKUP_DIR" -name "*.sql" -mtime +30 -delete
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +30 -delete

# å¯é€‰ï¼šä¸Šä¼ åˆ°äº‘å­˜å‚¨
# rclone copy "$BACKUP_DIR" remote:campus-wall-backups
```

## 10. âœ… éƒ¨ç½²éªŒè¯æ¸…å•

### æœåŠ¡å™¨éªŒè¯
- [ ] æœåŠ¡å™¨å¯ä»¥é€šè¿‡SSHè¿æ¥
- [ ] é˜²ç«å¢™é…ç½®æ­£ç¡®
- [ ] åŸŸåDNSè§£ææ­£ç¡®

### æœåŠ¡éªŒè¯  
- [ ] MySQLæœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] RedisæœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] NginxæœåŠ¡è¿è¡Œæ­£å¸¸
- [ ] PM2ç®¡ç†çš„Node.jsæœåŠ¡è¿è¡Œæ­£å¸¸

### APIéªŒè¯
- [ ] HTTP APIæ¥å£å¯è®¿é—® (ä¸´æ—¶æµ‹è¯•)
- [ ] HTTPS APIæ¥å£å¯è®¿é—®
- [ ] SSLè¯ä¹¦é…ç½®æ­£ç¡®
- [ ] è·¨åŸŸé…ç½®æ­£ç¡®

### ç§»åŠ¨ç«¯éªŒè¯
- [ ] ç§»åŠ¨ç«¯èƒ½æ­£å¸¸è¯·æ±‚API
- [ ] ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½æ­£å¸¸
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] å®æ—¶åŠŸèƒ½(WebSocket)æ­£å¸¸

## 11. ğŸ†˜ å¸¸è§é—®é¢˜è§£å†³

### APIæ— æ³•è®¿é—®
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
pm2 status
sudo systemctl status nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
netstat -tlnp | grep :3000
netstat -tlnp | grep :80

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status
```

### è·¨åŸŸé—®é¢˜
```javascript
// åœ¨åç«¯app.jsä¸­ç¡®ä¿CORSé…ç½®æ­£ç¡®
app.use(cors({
  origin: [
    'https://api.your-domain.com',
    'https://app.your-domain.com',
    'http://localhost:8080'  // å¼€å‘ç¯å¢ƒ
  ],
  credentials: true
}));
```

### SSLè¯ä¹¦é—®é¢˜
```bash
# æ£€æŸ¥è¯ä¹¦çŠ¶æ€
sudo certbot certificates

# å¼ºåˆ¶æ›´æ–°è¯ä¹¦
sudo certbot renew --force-renewal
```

### æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥MySQLçŠ¶æ€
sudo systemctl status mysql

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u campus_wall -p -h localhost campus_community
```

## 12. ğŸ“ˆ æ‰©å±•éƒ¨ç½²(å¯é€‰)

### è´Ÿè½½å‡è¡¡(å¤šå°æœåŠ¡å™¨)
```nginx
upstream backend {
    server 10.0.0.1:3000;
    server 10.0.0.2:3000;
    server 10.0.0.3:3000;
}

server {
    listen 443 ssl http2;
    server_name api.your-domain.com;
    
    location / {
        proxy_pass http://backend;
        # ... å…¶ä»–é…ç½®
    }
}
```

### CDNåŠ é€Ÿ
- ä½¿ç”¨é˜¿é‡Œäº‘CDNã€è…¾è®¯äº‘CDNç­‰åŠ é€Ÿé™æ€èµ„æº
- é…ç½®å›æºåœ°å€ä¸ºä½ çš„æœåŠ¡å™¨IP

### æ•°æ®åº“åˆ†ç¦»
- ä½¿ç”¨äº‘æ•°æ®åº“RDSä»£æ›¿è‡ªå»ºMySQL
- ä½¿ç”¨äº‘Redisä»£æ›¿è‡ªå»ºRedis

---

## ğŸ¯ éƒ¨ç½²å®Œæˆåçš„è®¿é—®åœ°å€

- **APIæ¥å£**: https://api.your-domain.com
- **ç®¡ç†åå°**: https://admin.your-domain.com  
- **ç§»åŠ¨ç«¯H5**: https://app.your-domain.com

**é‡è¦æé†’**: 
1. å°†æ‰€æœ‰ `your-domain.com` æ›¿æ¢ä¸ºä½ çš„å®é™…åŸŸå
2. ä¿®æ”¹æ‰€æœ‰å¯†ç ä¸ºå¼ºå¯†ç 
3. ç¡®ä¿ç§»åŠ¨ç«¯çš„APIåœ°å€é…ç½®æ­£ç¡®
4. å®šæœŸå¤‡ä»½æ•°æ®å’Œç›‘æ§æœåŠ¡çŠ¶æ€

éƒ¨ç½²å®Œæˆåï¼Œä½ çš„ç§»åŠ¨ç«¯åº”ç”¨å°±å¯ä»¥é€šè¿‡å…¬ç½‘APIæ­£å¸¸è®¿é—®åç«¯æœåŠ¡äº†ï¼ğŸš€







