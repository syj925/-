# å›¾ç‰‡URLè¿ç§»æŒ‡å—

## ğŸ“‹ **é—®é¢˜æè¿°**

åŸç³»ç»Ÿåœ¨å­˜å‚¨å›¾ç‰‡URLæ—¶ä½¿ç”¨äº†ç»å¯¹è·¯å¾„ï¼ˆåŒ…å«IPåœ°å€ï¼‰ï¼Œè¿™ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. **å¼€å‘ç¯å¢ƒIPå˜åŒ–**ï¼šå¼€å‘æ—¶IPåœ°å€ç»å¸¸å˜åŒ–
2. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²**ï¼šç”Ÿäº§æœåŠ¡å™¨IPä¸å¼€å‘ç¯å¢ƒä¸åŒ
3. **åŸŸåè®¿é—®**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨åŸŸåè€ŒéIP
4. **CDNéƒ¨ç½²**ï¼šå›¾ç‰‡å¯èƒ½éœ€è¦éƒ¨ç½²åˆ°CDN

## ğŸ”§ **è§£å†³æ–¹æ¡ˆ**

### **1. åç«¯æ”¹è¿›**

#### **é…ç½®æ–‡ä»¶æ›´æ–°**
- æ–°å¢ `server.domain` é…ç½®é¡¹
- æ–°å¢ `upload.urlStrategy` é…ç½®é¡¹
- æ”¯æŒç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ä¸¤ç§ç­–ç•¥

#### **ä¸Šä¼ ä¸­é—´ä»¶ä¼˜åŒ–**
- æ™ºèƒ½URLç”Ÿæˆç­–ç•¥
- æ”¯æŒåŸŸåé…ç½®
- å…¼å®¹æ—§ç‰ˆæœ¬ç»å¯¹è·¯å¾„

### **2. å‰ç«¯æ”¹è¿›**

#### **URLå·¥å…·å‡½æ•°å¢å¼º**
- æ™ºèƒ½æ£€æµ‹å’Œä¿®æ­£æ—§IPåœ°å€
- æ”¯æŒç›¸å¯¹è·¯å¾„è‡ªåŠ¨æ‹¼æ¥
- æ›´æ–°æ­£ç¡®çš„æœåŠ¡å™¨IPåœ°å€

#### **é…ç½®æ–‡ä»¶æ›´æ–°**
- ä½¿ç”¨æ­£ç¡®çš„æœåŠ¡å™¨IPï¼š`172.168.9.133`
- ç§»é™¤é”™è¯¯çš„IPåœ°å€é…ç½®

### **3. æ•°æ®åº“è¿ç§»**

#### **è¿ç§»è„šæœ¬åŠŸèƒ½**
- è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢ç»å¯¹URLä¸ºç›¸å¯¹è·¯å¾„
- æ”¯æŒJSONå­—æ®µå’Œå­—ç¬¦ä¸²å­—æ®µ
- äº‹åŠ¡ä¿æŠ¤ï¼Œç¡®ä¿æ•°æ®å®‰å…¨

## ğŸš€ **éƒ¨ç½²æ­¥éª¤**

### **å¼€å‘ç¯å¢ƒ**

1. **æ›´æ–°é…ç½®**
```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp server/.env.example server/.env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
# è®¾ç½® UPLOAD_URL_STRATEGY=relative
```

2. **è¿è¡Œè¿ç§»è„šæœ¬**
```bash
cd server
node scripts/migrate-image-urls.js
```

3. **é‡å¯æœåŠ¡**
```bash
npm restart
```

### **ç”Ÿäº§ç¯å¢ƒ**

1. **é…ç½®ç¯å¢ƒå˜é‡**
```bash
# å¤åˆ¶ç”Ÿäº§ç¯å¢ƒé…ç½®
cp server/.env.production.example server/.env.production

# ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®ï¼š
# SERVER_DOMAIN=your-domain.com
# USE_HTTPS=true
# UPLOAD_URL_STRATEGY=relative
```

2. **å¤‡ä»½æ•°æ®åº“**
```bash
mysqldump -u username -p database_name > backup.sql
```

3. **è¿è¡Œè¿ç§»**
```bash
NODE_ENV=production node scripts/migrate-image-urls.js
```

4. **éƒ¨ç½²æ–°ç‰ˆæœ¬**
```bash
# éƒ¨ç½²åç«¯
pm2 restart campus-wall-api

# éƒ¨ç½²å‰ç«¯
# æ„å»ºå¹¶éƒ¨ç½²å‰ç«¯åº”ç”¨
```

## ğŸ“Š **é…ç½®é€‰é¡¹**

### **åç«¯é…ç½®**

```javascript
// config/index.js
{
  server: {
    domain: 'api.example.com',  // ç”Ÿäº§åŸŸå
    useHttps: true,             // æ˜¯å¦ä½¿ç”¨HTTPS
    staticPath: '/uploads'      // é™æ€æ–‡ä»¶è·¯å¾„
  },
  upload: {
    urlStrategy: 'relative'     // 'relative' | 'absolute'
  }
}
```

### **å‰ç«¯é…ç½®**

```javascript
// src/config/index.js
{
  development: {
    serverUrls: [
      'http://localhost:3000',
      'http://172.168.9.133:3000'  // æ­£ç¡®çš„å¼€å‘æœåŠ¡å™¨IP
    ]
  },
  production: {
    serverUrls: [
      'https://api.example.com'    // ç”Ÿäº§ç¯å¢ƒåŸŸå
    ]
  }
}
```

## ğŸ” **éªŒè¯æ–¹æ³•**

### **1. æ£€æŸ¥æ•°æ®åº“**
```sql
-- æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç»å¯¹URL
SELECT id, images FROM posts WHERE images LIKE '%http%';
SELECT id, avatar FROM users WHERE avatar LIKE '%http%';
```

### **2. æµ‹è¯•ä¸Šä¼ åŠŸèƒ½**
- ä¸Šä¼ æ–°å›¾ç‰‡ï¼Œæ£€æŸ¥è¿”å›çš„URLæ ¼å¼
- ç¡®è®¤å›¾ç‰‡èƒ½æ­£å¸¸æ˜¾ç¤º

### **3. æ£€æŸ¥ç°æœ‰å›¾ç‰‡**
- æµè§ˆç°æœ‰å¸–å­ï¼Œç¡®è®¤å›¾ç‰‡æ­£å¸¸æ˜¾ç¤º
- æ£€æŸ¥ç”¨æˆ·å¤´åƒæ˜¯å¦æ­£å¸¸

## âš ï¸ **æ³¨æ„äº‹é¡¹**

1. **å¤‡ä»½é‡è¦æ€§**ï¼šè¿ç§»å‰åŠ¡å¿…å¤‡ä»½æ•°æ®åº“
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»è„šæœ¬
3. **å›æ»šå‡†å¤‡**ï¼šå‡†å¤‡å›æ»šæ–¹æ¡ˆä»¥é˜²å‡ºç°é—®é¢˜
4. **åˆ†æ‰¹è¿ç§»**ï¼šå¤§é‡æ•°æ®å¯è€ƒè™‘åˆ†æ‰¹è¿ç§»
5. **ç›‘æ§æ—¥å¿—**ï¼šè¿ç§»åå¯†åˆ‡ç›‘æ§åº”ç”¨æ—¥å¿—

## ğŸ¯ **é¢„æœŸæ•ˆæœ**

### **è¿ç§»å‰**
```
æ•°æ®åº“å­˜å‚¨ï¼šhttp://192.168.1.11:3000/uploads/images/abc.jpg
å‰ç«¯æ˜¾ç¤ºï¼š  http://192.168.1.11:3000/uploads/images/abc.jpg
```

### **è¿ç§»å**
```
æ•°æ®åº“å­˜å‚¨ï¼š/uploads/images/abc.jpg
å‰ç«¯æ˜¾ç¤ºï¼š  http://172.168.9.133:3000/uploads/images/abc.jpg (å¼€å‘ç¯å¢ƒ)
           https://api.example.com/uploads/images/abc.jpg (ç”Ÿäº§ç¯å¢ƒ)
```

## ğŸ”„ **å›æ»šæ–¹æ¡ˆ**

å¦‚æœè¿ç§»å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **æ¢å¤æ•°æ®åº“å¤‡ä»½**
```bash
mysql -u username -p database_name < backup.sql
```

2. **å›é€€ä»£ç ç‰ˆæœ¬**
```bash
git checkout previous-version
pm2 restart campus-wall-api
```

3. **ä¸´æ—¶ä¿®å¤**
- ä¿®æ”¹å‰ç«¯URLå·¥å…·å‡½æ•°
- æ‰‹åŠ¨ä¿®æ­£é—®é¢˜URL

## ğŸ“ **æŠ€æœ¯æ”¯æŒ**

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š

1. æ£€æŸ¥è¿ç§»è„šæœ¬æ—¥å¿—
2. éªŒè¯æ•°æ®åº“è¿æ¥é…ç½®
3. ç¡®è®¤ç¯å¢ƒå˜é‡è®¾ç½®
4. æŸ¥çœ‹åº”ç”¨é”™è¯¯æ—¥å¿—
