# 热门评论排序算法设计

## 算法概述

热门评论排序算法结合了**点赞数权重**和**时间衰减权重**，确保既考虑评论的受欢迎程度，又保持时效性，避免老评论长期霸榜。

## 核心公式

```
热度分数 = (点赞数权重 × 点赞数) + (时间权重 × 时间衰减因子)

其中：
- 点赞数权重 = 0.7 (70%权重)
- 时间权重 = 0.3 (30%权重)
- 时间衰减因子 = e^(-衰减率 × 小时差)
```

## 详细算法

### 1. 点赞数权重计算
```
点赞分数 = log(点赞数 + 1) × 点赞数权重
```
- 使用对数函数避免点赞数过大时的极端值
- +1 避免 log(0) 的情况

### 2. 时间衰减计算
```
时间衰减因子 = e^(-0.1 × 小时差)
时间分数 = 时间衰减因子 × 时间权重
```
- 衰减率 0.1：每10小时衰减约63%
- 24小时后衰减约91%
- 48小时后衰减约99%

### 3. 最终热度分数
```
热度分数 = 点赞分数 + 时间分数
```

## 排序方式定义

### 1. latest (最新)
```sql
ORDER BY created_at DESC
```

### 2. hot (最热)
```sql
ORDER BY 热度分数 DESC, created_at DESC
```

### 3. most_liked (点赞最多)
```sql
ORDER BY like_count DESC, created_at DESC
```

## 实现方案

### 方案1：数据库计算 (推荐)
在SQL查询中直接计算热度分数：

```sql
SELECT *,
  (0.7 * LOG(like_count + 1) + 
   0.3 * EXP(-0.1 * TIMESTAMPDIFF(HOUR, created_at, NOW()))) as hot_score
FROM comments 
WHERE post_id = ? AND reply_to IS NULL AND status = 'normal'
ORDER BY hot_score DESC, created_at DESC
```

### 方案2：应用层计算
在应用代码中计算热度分数，适用于复杂逻辑。

## 性能优化

### 1. 数据库索引
```sql
-- 复合索引优化排序查询
CREATE INDEX idx_comments_hot_sort ON comments(post_id, status, reply_to, like_count, created_at);
```

### 2. 缓存策略
- 热门评论列表缓存5分钟
- 点赞数变化时清除相关缓存

## 热门评论标识规则

### 热门评论判定条件
1. **点赞数 ≥ 5** 且 **热度分数 > 平均分数**
2. 或者 **点赞数 ≥ 10**（绝对热门）

### 视觉标识
- 🔥 火焰图标
- "热门" 标签
- 特殊背景色或边框

## 算法参数调优

### 可调参数
- `点赞权重`: 0.7 (可调整为 0.6-0.8)
- `时间权重`: 0.3 (可调整为 0.2-0.4)
- `衰减率`: 0.1 (可调整为 0.05-0.2)
- `热门阈值`: 5点赞 (可调整为 3-10)

### A/B测试建议
1. 测试不同权重比例的用户参与度
2. 测试不同衰减率的评论活跃度
3. 测试热门标识对用户行为的影响

## 示例计算

### 示例1：新评论高点赞
- 点赞数：15
- 发布时间：2小时前
- 点赞分数：0.7 × log(16) = 0.7 × 2.77 = 1.94
- 时间分数：0.3 × e^(-0.1×2) = 0.3 × 0.82 = 0.25
- **热度分数：1.94 + 0.25 = 2.19**

### 示例2：老评论高点赞
- 点赞数：30
- 发布时间：24小时前
- 点赞分数：0.7 × log(31) = 0.7 × 3.43 = 2.40
- 时间分数：0.3 × e^(-0.1×24) = 0.3 × 0.09 = 0.03
- **热度分数：2.40 + 0.03 = 2.43**

### 示例3：新评论低点赞
- 点赞数：3
- 发布时间：1小时前
- 点赞分数：0.7 × log(4) = 0.7 × 1.39 = 0.97
- 时间分数：0.3 × e^(-0.1×1) = 0.3 × 0.90 = 0.27
- **热度分数：0.97 + 0.27 = 1.24**

## 结论

该算法能够：
1. ✅ 平衡热度和时效性
2. ✅ 避免老评论长期霸榜
3. ✅ 鼓励新评论获得曝光
4. ✅ 保持评论区活跃度
5. ✅ 提供良好的用户体验
