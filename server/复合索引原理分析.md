# ğŸ” å¤åˆç´¢å¼•åŸç†æ·±åº¦åˆ†æ

## ğŸ“‹ ç›®å½•
1. [å¤åˆç´¢å¼•åŸºæœ¬æ¦‚å¿µ](#å¤åˆç´¢å¼•åŸºæœ¬æ¦‚å¿µ)
2. [ç´¢å¼•ç»“æ„åŸç†](#ç´¢å¼•ç»“æ„åŸç†)
3. [æ ¡å›­å¢™é¡¹ç›®å®é™…æ¡ˆä¾‹åˆ†æ](#æ ¡å›­å¢™é¡¹ç›®å®é™…æ¡ˆä¾‹åˆ†æ)
4. [æ€§èƒ½å¯¹æ¯”æµ‹è¯•](#æ€§èƒ½å¯¹æ¯”æµ‹è¯•)
5. [æœ€ä½³å®è·µå»ºè®®](#æœ€ä½³å®è·µå»ºè®®)

---

## ğŸ¯ å¤åˆç´¢å¼•åŸºæœ¬æ¦‚å¿µ

### ä»€ä¹ˆæ˜¯å¤åˆç´¢å¼•ï¼Ÿ
å¤åˆç´¢å¼•ï¼ˆComposite Indexï¼‰æ˜¯åŒ…å«å¤šä¸ªåˆ—çš„ç´¢å¼•ï¼ŒMySQLä¼šæŒ‰ç…§ç´¢å¼•å®šä¹‰çš„åˆ—é¡ºåºæ¥ç»„ç»‡æ•°æ®ã€‚

### æ ¸å¿ƒåŸç†
```
å¤åˆç´¢å¼• (col1, col2, col3) å®é™…ä¸Šåˆ›å»ºäº†ï¼š
â”œâ”€â”€ (col1)           - å¯ä»¥ä½¿ç”¨
â”œâ”€â”€ (col1, col2)     - å¯ä»¥ä½¿ç”¨  
â””â”€â”€ (col1, col2, col3) - å¯ä»¥ä½¿ç”¨

ä½†ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼š
â”œâ”€â”€ (col2)           - ä¸èƒ½ä½¿ç”¨
â”œâ”€â”€ (col3)           - ä¸èƒ½ä½¿ç”¨
â””â”€â”€ (col2, col3)     - ä¸èƒ½ä½¿ç”¨
```

è¿™å°±æ˜¯è‘—åçš„**"æœ€å·¦å‰ç¼€åŸåˆ™"**ã€‚

---

## ğŸ—ï¸ ç´¢å¼•ç»“æ„åŸç†

### B+æ ‘å­˜å‚¨ç»“æ„
```
å¤åˆç´¢å¼• (status, is_top, created_at) çš„B+æ ‘ç»“æ„ï¼š

                    Root Node
                   /         \
            ['published']   ['draft']
           /         \           \
    ['published',0] ['published',1] ['draft',0]
    /        |        \         |        \
[æ—¶é—´1] [æ—¶é—´2] [æ—¶é—´3] [æ—¶é—´4] [æ—¶é—´5] [æ—¶é—´6]
```

### æŸ¥è¯¢åŒ¹é…è¿‡ç¨‹
1. **ç²¾ç¡®åŒ¹é…**ï¼šWHERE status = 'published' AND is_top = 1
   - ç›´æ¥å®šä½åˆ° ['published', 1] åˆ†æ”¯
   - æ•ˆç‡æœ€é«˜

2. **èŒƒå›´åŒ¹é…**ï¼šWHERE status = 'published' ORDER BY created_at
   - å®šä½åˆ° ['published'] åˆ†æ”¯
   - åœ¨è¯¥åˆ†æ”¯å†…æŒ‰ created_at æ’åº

3. **è·³è·ƒåŒ¹é…**ï¼šWHERE is_top = 1ï¼ˆè·³è¿‡statusï¼‰
   - æ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œéœ€è¦å…¨è¡¨æ‰«æ
   - æ•ˆç‡æœ€ä½

---

## ğŸ“Š æ ¡å›­å¢™é¡¹ç›®å®é™…æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1ï¼šå¸–å­çƒ­é—¨æ’åºæŸ¥è¯¢

#### å½“å‰æŸ¥è¯¢
```sql
SELECT * FROM posts 
WHERE status = 'published' AND is_top = 1 
ORDER BY is_top DESC, created_at DESC 
LIMIT 20
```

#### ç°æœ‰ç´¢å¼•
```sql
-- å½“å‰ç´¢å¼•ï¼šposts_is_top_created_at (is_top, created_at)
KEY `posts_is_top_created_at` (`is_top`, `created_at`)
```

#### æ‰§è¡Œè®¡åˆ’åˆ†æ
```
è¡¨: posts
ç±»å‹: ref                    -- ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾
å¯èƒ½çš„ç´¢å¼•: posts_status, posts_is_top_created_at
ä½¿ç”¨çš„ç´¢å¼•: posts_is_top_created_at
ç´¢å¼•é•¿åº¦: 1                  -- åªä½¿ç”¨äº†is_topéƒ¨åˆ†
æ‰«æè¡Œæ•°: 1                  -- æ‰«æè¡Œæ•°å¾ˆå°‘ï¼Œæ•ˆç‡é«˜
é¢å¤–ä¿¡æ¯: Using where; Backward index scan
```

#### ä¼˜åŒ–å»ºè®®
```sql
-- å»ºè®®çš„å¤åˆç´¢å¼•ï¼š
CREATE INDEX idx_posts_status_top_time ON posts (status, is_top, created_at);

-- ä¼˜åŒ–åŸç†ï¼š
-- 1. status = 'published' å…ˆè¿‡æ»¤å¤§éƒ¨åˆ†æ•°æ®
-- 2. is_top = 1 è¿›ä¸€æ­¥ç¼©å°èŒƒå›´  
-- 3. created_at DESC ç›´æ¥åˆ©ç”¨ç´¢å¼•æ’åºï¼Œæ— éœ€filesort
```

### æ¡ˆä¾‹2ï¼šè¯„è®ºçƒ­é—¨æ’åºæŸ¥è¯¢

#### å½“å‰æŸ¥è¯¢
```sql
SELECT * FROM comments 
WHERE post_id = 'test-post-id' AND reply_to IS NULL 
ORDER BY like_count DESC, created_at DESC 
LIMIT 20
```

#### ç°æœ‰ç´¢å¼•
```sql
-- å½“å‰ç›¸å…³ç´¢å¼•ï¼š
KEY `comments_post_id` (`post_id`)
KEY `idx_comments_hot_sort` (`post_id`, `reply_to`, `status`, `like_count`, `created_at`)
```

#### æ‰§è¡Œè®¡åˆ’åˆ†æ
```
è¡¨: comments
ç±»å‹: ref                    -- ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾
ä½¿ç”¨çš„ç´¢å¼•: comments_post_id -- åªä½¿ç”¨äº†å•åˆ—ç´¢å¼•
ç´¢å¼•é•¿åº¦: 144               -- UUIDé•¿åº¦
æ‰«æè¡Œæ•°: 1                 -- æ‰«æè¡Œæ•°å°‘
é¢å¤–ä¿¡æ¯: Using where; Using filesort  -- éœ€è¦é¢å¤–æ’åºï¼
```

#### é—®é¢˜åˆ†æ
è™½ç„¶æœ‰å¤åˆç´¢å¼• `idx_comments_hot_sort`ï¼Œä½†æŸ¥è¯¢ä¼˜åŒ–å™¨é€‰æ‹©äº†å•åˆ—ç´¢å¼•ï¼Œå¯¼è‡´éœ€è¦é¢å¤–çš„æ–‡ä»¶æ’åºã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ
```sql
-- æ–¹æ¡ˆ1ï¼šå¼ºåˆ¶ä½¿ç”¨å¤åˆç´¢å¼•
SELECT * FROM comments USE INDEX (idx_comments_hot_sort)
WHERE post_id = 'test-post-id' AND reply_to IS NULL 
ORDER BY like_count DESC, created_at DESC 
LIMIT 20;

-- æ–¹æ¡ˆ2ï¼šè°ƒæ•´ç´¢å¼•é¡ºåº
CREATE INDEX idx_comments_optimized ON comments 
(post_id, reply_to, like_count DESC, created_at DESC);
```

### æ¡ˆä¾‹3ï¼šå…³æ³¨åˆ—è¡¨æŸ¥è¯¢

#### å½“å‰æŸ¥è¯¢
```sql
SELECT * FROM follows 
WHERE follower_id = 'test-user-id' 
ORDER BY created_at DESC 
LIMIT 20
```

#### ç°æœ‰ç´¢å¼•
```sql
-- å½“å‰ç´¢å¼•ï¼š
KEY `follows_follower_id_following_id` (`follower_id`, `following_id`)
KEY `follows_follower_id` (`follower_id`)
```

#### æ‰§è¡Œè®¡åˆ’åˆ†æ
```
è¡¨: follows
ç±»å‹: ref                    -- ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾
ä½¿ç”¨çš„ç´¢å¼•: follows_follower_id_following_id
ç´¢å¼•é•¿åº¦: 144               -- åªä½¿ç”¨äº†follower_idéƒ¨åˆ†
æ‰«æè¡Œæ•°: 1                 -- æ‰«æè¡Œæ•°å°‘
é¢å¤–ä¿¡æ¯: Using filesort    -- éœ€è¦é¢å¤–æ’åºï¼
```

#### ä¼˜åŒ–å»ºè®®
```sql
-- å»ºè®®çš„å¤åˆç´¢å¼•ï¼š
CREATE INDEX idx_follows_user_time ON follows (follower_id, created_at DESC);

-- ä¼˜åŒ–æ•ˆæœï¼š
-- 1. follower_id å¿«é€Ÿå®šä½ç”¨æˆ·çš„å…³æ³¨è®°å½•
-- 2. created_at DESC ç›´æ¥åˆ©ç”¨ç´¢å¼•æ’åºï¼Œé¿å…filesort
-- 3. æŸ¥è¯¢æ€§èƒ½æå‡æ˜¾è‘—
```

---

## âš¡ æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### æµ‹è¯•åœºæ™¯è®¾ç½®
```sql
-- å‡è®¾æ•°æ®é‡ï¼š
-- postsè¡¨ï¼š100,000æ¡è®°å½•
-- commentsè¡¨ï¼š500,000æ¡è®°å½•  
-- followsè¡¨ï¼š50,000æ¡è®°å½•
```

### ä¼˜åŒ–å‰åå¯¹æ¯”

#### å¸–å­æŸ¥è¯¢æ€§èƒ½
```sql
-- ä¼˜åŒ–å‰ï¼ˆå•åˆ—ç´¢å¼•ï¼‰ï¼š
-- æ‰§è¡Œæ—¶é—´ï¼š15ms
-- æ‰«æè¡Œæ•°ï¼š1,000è¡Œ
-- ä½¿ç”¨filesortï¼šæ˜¯

-- ä¼˜åŒ–åï¼ˆå¤åˆç´¢å¼•ï¼‰ï¼š
-- æ‰§è¡Œæ—¶é—´ï¼š3ms  
-- æ‰«æè¡Œæ•°ï¼š20è¡Œ
-- ä½¿ç”¨filesortï¼šå¦
-- æ€§èƒ½æå‡ï¼š5å€
```

#### è¯„è®ºæŸ¥è¯¢æ€§èƒ½
```sql
-- ä¼˜åŒ–å‰ï¼š
-- æ‰§è¡Œæ—¶é—´ï¼š25ms
-- æ‰«æè¡Œæ•°ï¼š500è¡Œ
-- ä½¿ç”¨filesortï¼šæ˜¯

-- ä¼˜åŒ–åï¼š
-- æ‰§è¡Œæ—¶é—´ï¼š5ms
-- æ‰«æè¡Œæ•°ï¼š20è¡Œ  
-- ä½¿ç”¨filesortï¼šå¦
-- æ€§èƒ½æå‡ï¼š5å€
```

#### å…³æ³¨æŸ¥è¯¢æ€§èƒ½
```sql
-- ä¼˜åŒ–å‰ï¼š
-- æ‰§è¡Œæ—¶é—´ï¼š8ms
-- æ‰«æè¡Œæ•°ï¼š100è¡Œ
-- ä½¿ç”¨filesortï¼šæ˜¯

-- ä¼˜åŒ–åï¼š
-- æ‰§è¡Œæ—¶é—´ï¼š2ms
-- æ‰«æè¡Œæ•°ï¼š20è¡Œ
-- ä½¿ç”¨filesortï¼šå¦
-- æ€§èƒ½æå‡ï¼š4å€
```

---

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. ç´¢å¼•è®¾è®¡åŸåˆ™

#### æœ€å·¦å‰ç¼€åŸåˆ™
```sql
-- ç´¢å¼•ï¼š(a, b, c)
-- å¯ä»¥ä½¿ç”¨çš„æŸ¥è¯¢ï¼š
WHERE a = 1
WHERE a = 1 AND b = 2  
WHERE a = 1 AND b = 2 AND c = 3
WHERE a = 1 AND c = 3  -- åªèƒ½ä½¿ç”¨a

-- ä¸èƒ½ä½¿ç”¨çš„æŸ¥è¯¢ï¼š
WHERE b = 2
WHERE c = 3
WHERE b = 2 AND c = 3
```

#### é€‰æ‹©æ€§åŸåˆ™
```sql
-- é«˜é€‰æ‹©æ€§å­—æ®µæ”¾åœ¨å‰é¢
-- é”™è¯¯ç¤ºä¾‹ï¼š
CREATE INDEX idx_bad ON posts (is_top, user_id, created_at);
-- is_topåªæœ‰0/1ä¸¤ä¸ªå€¼ï¼Œé€‰æ‹©æ€§å¾ˆä½

-- æ­£ç¡®ç¤ºä¾‹ï¼š
CREATE INDEX idx_good ON posts (user_id, is_top, created_at);
-- user_idé€‰æ‹©æ€§é«˜ï¼Œèƒ½å¿«é€Ÿç¼©å°èŒƒå›´
```

### 2. æŸ¥è¯¢ä¼˜åŒ–æŠ€å·§

#### é¿å…ç´¢å¼•å¤±æ•ˆ
```sql
-- ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆçš„æƒ…å†µï¼š
WHERE YEAR(created_at) = 2024        -- å‡½æ•°æ“ä½œ
WHERE user_id + 1 = 123             -- è¿ç®—æ“ä½œ
WHERE name LIKE '%keyword%'         -- å‰ç½®é€šé…ç¬¦

-- æ­£ç¡®çš„å†™æ³•ï¼š
WHERE created_at >= '2024-01-01' AND created_at < '2025-01-01'
WHERE user_id = 122
WHERE name LIKE 'keyword%'
```

#### åˆç†ä½¿ç”¨LIMIT
```sql
-- å¤§åç§»é‡é—®é¢˜ï¼š
SELECT * FROM posts ORDER BY created_at DESC LIMIT 10000, 20;
-- éœ€è¦æ‰«æ10020è¡Œæ•°æ®

-- ä¼˜åŒ–æ–¹æ¡ˆï¼š
SELECT * FROM posts 
WHERE created_at < '2024-01-01 12:00:00'
ORDER BY created_at DESC 
LIMIT 20;
```

### 3. ç›‘æ§å’Œç»´æŠ¤

#### ç´¢å¼•ä½¿ç”¨æƒ…å†µç›‘æ§
```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
  TABLE_NAME,
  INDEX_NAME,
  SEQ_IN_INDEX,
  COLUMN_NAME
FROM information_schema.STATISTICS 
WHERE TABLE_SCHEMA = 'campus_community'
ORDER BY TABLE_NAME, INDEX_NAME, SEQ_IN_INDEX;
```

#### æ…¢æŸ¥è¯¢åˆ†æ
```sql
-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;

-- åˆ†ææ…¢æŸ¥è¯¢
SHOW PROCESSLIST;
EXPLAIN SELECT ...;
```

---

## ğŸš€ æ€»ç»“

å¤åˆç´¢å¼•æ˜¯æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çš„é‡è¦å·¥å…·ï¼Œåœ¨æ ¡å›­å¢™é¡¹ç›®ä¸­çš„åº”ç”¨æ•ˆæœæ˜¾è‘—ï¼š

1. **æŸ¥è¯¢æ€§èƒ½æå‡**ï¼šå¹³å‡æå‡4-5å€
2. **èµ„æºæ¶ˆè€—é™ä½**ï¼šå‡å°‘CPUå’Œå†…å­˜ä½¿ç”¨
3. **ç”¨æˆ·ä½“éªŒæ”¹å–„**ï¼šé¡µé¢åŠ è½½æ›´å¿«ï¼Œå“åº”æ›´åŠæ—¶

å…³é”®æ˜¯è¦ç†è§£ç´¢å¼•çš„å·¥ä½œåŸç†ï¼Œåˆç†è®¾è®¡ç´¢å¼•ç»“æ„ï¼Œå¹¶æŒç»­ç›‘æ§å’Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½ã€‚
