# 校园墙数据库恢复指南

> 🎯 **目标**: 解决系统重装后复杂数据库关联关系的重建问题
> 
> ⚡ **特点**: 一键自动化恢复，无需手动建表和设置关联

## 📋 问题背景

校园墙项目包含复杂的数据库关联关系和外键约束：

### **表依赖关系层次**
```
第1层 (基础表，无外键依赖):
├── users (用户表)
├── categories (分类表)
├── topics (话题表)
└── settings (设置表)

第2层 (依赖用户表):
├── search_histories (搜索历史) <- users
└── follows (关注关系) <- users

第3层 (依赖多个基础表):
└── posts (帖子表) <- users, categories, topics

第4层 (依赖帖子表):
├── post_images (帖子图片) <- posts
└── comments (评论表) <- users, posts

第5层 (复杂关联表):
├── likes (点赞表) <- users, posts, comments
├── favorites (收藏表) <- users, posts
└── messages (消息表) <- users, posts, comments
```

### **核心挑战**
- ❌ 外键约束要求被引用的表必须先存在
- ❌ 错误的创建顺序会导致外键约束失败
- ❌ 手动重建这些关系非常容易出错且耗时
- ❌ 传统的数据库导入可能因为顺序问题失败

## 🚀 解决方案

### **方案1: 一键恢复脚本 (推荐)**

#### Windows批处理版本
```bash
# 双击运行或命令行执行
restore-campus-wall.bat
```

#### PowerShell版本
```powershell
# 以管理员身份运行PowerShell
.\restore-campus-wall.ps1

# 可选参数:
.\restore-campus-wall.ps1 -SkipDependencies  # 跳过依赖安装
.\restore-campus-wall.ps1 -SkipDatabase     # 跳过数据库恢复
.\restore-campus-wall.ps1 -AutoStart        # 自动启动服务
```

### **方案2: 分步手动恢复**

#### 1. 环境准备
```bash
# 安装Node.js 18+
# 安装MySQL 8.0+
# 安装Redis (可选)
```

#### 2. 项目依赖安装
```bash
# 后端依赖
cd server
npm install

# 管理后台依赖  
cd ../admin
npm install

# 前端APP依赖
cd ../uni-APP
npm install
```

#### 3. 环境配置
```bash
# 创建环境变量文件
cd server
cp .env.example .env

# 编辑.env文件，配置数据库信息
# DB_HOST=localhost
# DB_USERNAME=root  
# DB_PASSWORD=20060711
# DB_NAME=campus_community
```

#### 4. 数据库恢复
```bash
# 方式1: 使用恢复脚本 (推荐)
npm run restore-db

# 方式2: 安全同步模式 (如果遇到外键问题)
npm run safe-sync                    # 按依赖顺序同步
npm run safe-sync -- --disable-fk   # 禁用外键检查同步

# 方式3: 分析依赖关系
npm run analyze-deps                 # 查看表依赖关系

# 方式4: 分步执行
npm run init-db      # 创建数据库和表结构
npm run seed-data    # 创建初始数据
```

#### 5. 启动服务
```bash
# 后端服务
cd server && npm run dev

# 管理后台
cd admin && npm run dev  

# 前端APP
cd uni-APP && npm run dev:h5
```

## 🛠️ 脚本功能说明

### **restore-database.js** - 核心恢复脚本
- ✅ 自动创建数据库
- ✅ 按依赖关系顺序加载模型定义
- ✅ 智能处理表创建的先后顺序
- ✅ 自动建立模型关联关系
- ✅ 使用Sequelize同步表结构
- ✅ 创建管理员账户和基础数据
- ✅ 智能错误处理和提示

### **safe-sync-models.js** - 安全同步脚本
- 🔄 按依赖层次分批创建表
- 🔒 可选的外键约束临时禁用
- 🔍 表结构验证和完整性检查
- ⚠️ 智能错误恢复机制

### **analyze-table-dependencies.js** - 依赖分析脚本
- 📊 分析表之间的依赖关系
- 🔍 检测循环依赖问题
- 📝 生成最优创建顺序
- 💡 提供优化建议

### **backup-database.js** - 数据备份脚本
```bash
# 在系统重装前备份数据
npm run backup-db
```
- 📦 备份数据库结构和数据
- 📁 备份上传文件
- 📝 生成恢复说明文档

### **restore-campus-wall.bat/ps1** - 一键恢复脚本
- 🔍 环境检查 (Node.js, MySQL)
- 📦 自动安装所有依赖
- 🗄️ 自动恢复数据库
- 📝 创建启动脚本
- 🚀 可选自动启动服务

## 📊 数据库模型关系

### **核心模型**
```
User (用户)
├── hasMany: Post (帖子)
├── hasMany: Comment (评论)  
├── hasMany: Like (点赞)
├── hasMany: Favorite (收藏)
├── hasMany: Follow (关注关系)
└── hasMany: Message (消息)

Post (帖子)
├── belongsTo: User (作者)
├── belongsTo: Category (分类)
├── belongsTo: Topic (话题)
├── hasMany: Comment (评论)
├── hasMany: Like (点赞)
├── hasMany: Favorite (收藏)
└── hasMany: PostImage (图片)

Comment (评论)
├── belongsTo: User (评论者)
├── belongsTo: Post (所属帖子)
├── belongsTo: Comment (父评论)
├── hasMany: Comment (子评论)
└── hasMany: Like (点赞)
```

### **关联表**
- **likes**: 点赞关系 (用户 ↔ 帖子/评论)
- **favorites**: 收藏关系 (用户 ↔ 帖子)
- **follows**: 关注关系 (用户 ↔ 用户)
- **post_images**: 帖子图片关系

## 🔧 故障排除

### **常见问题**

#### 1. 外键约束错误
```bash
# 错误信息: Cannot add foreign key constraint
# 解决方案:
npm run safe-sync -- --disable-fk   # 禁用外键检查同步
# 或
npm run analyze-deps                 # 分析依赖关系，按正确顺序创建
```

#### 2. 表创建顺序错误
```bash
# 错误信息: Table doesn't exist / Referenced table not found
# 解决方案:
npm run safe-sync                    # 使用安全同步模式
# 或手动按顺序创建:
# 1. users, categories, topics, settings
# 2. search_histories, follows
# 3. posts
# 4. post_images, comments
# 5. likes, favorites, messages
```

#### 3. MySQL连接失败
```bash
# 检查MySQL服务状态
net start mysql

# 检查端口占用
netstat -an | findstr 3306

# 重置MySQL密码
mysqladmin -u root password 20060711
```

#### 2. 依赖安装失败
```bash
# 清理npm缓存
npm cache clean --force

# 删除node_modules重新安装
rm -rf node_modules
npm install
```

#### 3. 数据库权限问题
```sql
-- 创建用户并授权
CREATE USER 'root'@'localhost' IDENTIFIED BY '20060711';
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

#### 4. 端口冲突
```bash
# 检查端口占用
netstat -ano | findstr :3000
netstat -ano | findstr :8888

# 结束占用进程
taskkill /PID <进程ID> /F
```

### **日志查看**
```bash
# 后端服务日志
cd server && npm run dev

# 数据库恢复日志
npm run restore-db

# 查看错误日志
cat server/logs/error.log
```

## 📝 注意事项

### **重要提醒**
- ⚠️ 恢复前请确保MySQL服务正在运行
- ⚠️ 数据库密码默认为 `20060711`，请根据实际情况修改
- ⚠️ 首次启动可能需要较长时间编译
- ⚠️ 确保防火墙允许相关端口访问

### **默认配置**
- 🔌 后端服务: http://localhost:3000
- 🎛️ 管理后台: http://localhost:8888
- 📱 前端APP: http://localhost:5173
- 👤 管理员账户: admin / admin123

### **系统要求**
- 💻 Windows 10/11
- 🟢 Node.js 18+
- 🗄️ MySQL 8.0+
- 💾 至少2GB可用空间

## 🎉 恢复完成后

### **验证步骤**
1. ✅ 访问管理后台: http://localhost:8888
2. ✅ 使用 admin/admin123 登录
3. ✅ 检查用户管理、帖子管理等功能
4. ✅ 访问前端APP: http://localhost:5173
5. ✅ 测试注册、登录、发帖等功能

### **下一步操作**
- 📝 修改默认管理员密码
- 🔧 根据需要调整配置文件
- 📊 导入历史数据 (如有)
- 🚀 部署到生产环境

---

> 💡 **提示**: 建议在系统重装前运行 `npm run backup-db` 备份重要数据
> 
> 🆘 **支持**: 如遇问题请检查控制台输出或查看日志文件
