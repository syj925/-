---
description: 统一本仓库的代码协作约定与 AI 辅助编程指引（xm 规则）
alwaysApply: false
---
### 适用范围
- **前端**: `admin/src/**/*`、`uni-APP/src/**/*`
- **后端**: `server/src/**/*`、`server/scripts/**/*`

### API 响应约定
- **成功判断**: 使用 `res.code === 0 || res.success === true`
- **消息字段**: 使用 `res.msg || res.message`
- **数据字段**: 优先 `res.data`
- **失败提示**: 统一在前端使用 `ElMessage.error(message || '操作失败')`

### 分页与检索参数
- **分页字段**: `page`, `limit`
- **搜索字段**: `title`, `status`, `startDate`, `endDate`
- **防缓存**: 请求参数补充 `_t: Date.now()`

### 活动管理字段与规则
- **状态枚举**: `upcoming | ongoing | ended | canceled`
- **取消/恢复逻辑**: 恢复已取消活动时，按 `start_time` 与 `end_time` 计算实时状态
- **人数上限**: `max_participants = 0` 表示不限制
- **推荐位**: `is_recommended` 为布尔值
- **报名截止**: `registration_deadline` 仅在为有效日期时发送
- **报名表单 `form_config`**:
  - 每个字段需包含 `name`, `label`, `type`
  - 当 `type === 'select'` 时必须携带 `options: string[]`（可为空数组）
  - 过滤无效项：名称/标签为空的字段不提交
- **须知 `notices`**: 过滤空字符串

### 日期与时间
- 前端统一使用 `value-format="YYYY-MM-DD HH:mm:ss"`
- 展示统一 `toLocaleString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })`

### 上传约定
- **接口地址**: `/api/upload`
- **认证头**: `Authorization: Bearer ${localStorage.getItem('admin_token')}`
- **成功判断**: `response.code === 0`
- **图片 URL 处理**:
  - 若 `response.data.url` 非 `http` 开头，拼接 `http://localhost:3000${response.data.url}`（按环境修改主机名）

### 错误与日志
- 统一异常提示：`ElMessage.error(err.message || '请求失败')`
- 控制台日志前缀：前端以模块名开头（如“活动管理:”），后端使用 `logger` 结构化输出

### 代码风格补充
- 命名使用完整单词，避免缩写
- 采用早返回，避免深层嵌套
- 注释解释“为什么”，避免解释“做了什么”的冗余注释
- 避免遗留 TODO；能实现则直接实现并覆盖测试

### 变更影响面
- 当修改接口响应结构或字段名时，同时更新：
  - `admin/src/utils/api.js`
  - 相关视图文件（如 `admin/src/views/event/*.vue`）
  - 服务器端 `server/src/controllers/*.js` 与 `server/src/services/*.js` 中的响应构造

### 参考文档
- `docs/响应格式兼容性问题修复文档.md`
- `docs/图片URL迁移指南.md`
- `server/campus-wall-api-specification.md`

### 项目历史
- `uni-APP初版` 具备完整功能但仅在 H5 模式正常；打包 App 出现白屏后弃用。
- 当前项目路径：`C:\\Users\\26933\\Desktop\\校园墙`。

### 项目需求与偏好
- 偏好在迁移中“重设计重实现”，而非简单复制粘贴。
- 需要详细的项目管理文档（优先级、工时估算、技术规格、测试要求）。
- 采用模块化与现代分层（Controller → Service → Repository → Model），遵循 RESTful，开发需配套完整测试。
- 先研读迁移文档，复用既有系统（如关注系统）的架构模式，保持兼容性。
- UI 需基于现有页面布局与组件，追求合理性与一致性，避免随意新建样式与页面。
- 首页热评预览：展示点赞数 Top 3 的评论；轻量化样式；移动端优化；支持直接点赞与跳转至用户主页。
- 新功能实现必须包含测试。
- 全局样式使用 SCSS，避免转为普通 CSS；若 IDE 移除了 SCSS 引用，优先恢复正确的 SCSS 引入而不是改写为 CSS。
- 严格校验管理后台、前端 App 与数据库字段的数据格式兼容性，落地前确认字段类型与响应结构。
- 两阶段策略：优先实现管理后台后端 API，按精确契约完成；再优化前端，避免为迁就后端短板而妥协前端。
- 增量、按功能分批开发，避免一次性铺开所有接口。
- 管理后台需运行在端口 8888（替代默认 8081）。
- 数据库脚本应整洁，移除无关的分类初始化；谨慎使用模型同步，避免破坏现有数据。
- 后台管理文档与前端 App 迁移文档分离维护，不混写。
- 统一沿用分层架构、REST 规范、完成自测与文档更新。
- 禁用简化页面与 mock 数据，使用真实 API 完整实现。
- 追求高质量 UI，若质量不佳将要求重设。
- 话题创建需独立页面/界面，而非仅一个输入框。
- 新建话题：话题名从搜索输入自动带入，最长 10 字；不含话题类型选择功能。
- 搜索功能遵循既有模式：分层架构、统一响应格式 `{code: 0, msg: '成功', data: {...}}`、合法性校验与错误处理；前端复用现有组件与设计体系。
- 全局校验风格一致，避免混用 joi 与 express-validator 造成割裂与回归风险。
- 尽量复用既有 UI 模式（如首页帖子卡片）以保持一致性。
- 结构化的功能开发流程：
  1) 需求分析（基于项目文档）；
  2) 后端 API 校验/修改（先完成契约）；
  3) 前端实现（保持 UI 一致性）；
  4) 功能测试（对照分层架构模式）。
- 开发过程中不直接对比新旧 API；旧版仅作参考。界面显示以“昵称”替代“用户名”。
- 当总量可控时偏好一次性展示全量而非分页，同时需考虑 100+ 的可扩展性。
- 关心首页在数据量超过 100 条的情况下仍能正常工作。
- 将分页上限等系统配置项纳入管理后台可配置项；新功能文档按后台开发进度文档的既定格式更新。
- 文档更新需谨慎细致，避免到处添加不必要的内容。
- 审视并改进隐私设置相关内容与交互设计。
- 支持实时保存的设置页面应移除“手动保存”按钮。
- 理解匿名功能的前后端实现差异与安全边界，基于安全与一致性做权衡。
- 匿名帖子仅在个人主页展示标识/提示，不在全站其他页面泛化展示。
- 个人主页不鼓励显示“匿名用户”作为昵称，需另行明确设计策略。
- 架构风格需大部分一致，避免在不同位置采用截然不同的方法论。
- ORM 查询优先，避免与原生 SQL 混用导致风格分裂（除非经评估必要）。
- ID 显示优化仅限已完成的用户管理页，不扩展到活动、标签等其他管理页面。
- 禁止硬编码 IP 地址。
- 性能优化（如建索引）在核心功能闭环后再进行，避免过早优化。
- 文案与标注使用“账号”而非“用户名”。

### 已实现功能
- 多级回复与 @用户 功能已实现并通过测试：用户搜索、多级回复创建、回复树查询、直系回复查询、评论列表展示均工作正常。
- 帖子内容搜索、搜索历史记录、热搜推荐功能已完成。

### 系统设计与环境约束
- 点赞系统区分帖子点赞与评论点赞，前后端与数据层实现需清晰区分。
- 正确 API 服务端口为 3000（非 3001）。
- 正确 API Server 地址为 `http://localhost:3000`（非 192.168.159.1/172.168.9.133 等）。
- 避免将携带 IP 的图片 URL 写入数据库，偏好存相对路径，运行时拼接基地址。
- 头像等图片在库中为相对路径（如 `/uploads/images/xxx.png`），前端需拼接服务器基地址生成完整 URL。
- 框架样式使用 SCSS，保持不变。
- MySQL 数据库密码为 `20060711`；实际数据库名不同于 `campus_wall`（以本地有效配置为准）。
- 话题 API 可能未返回完整作者字段（昵称/账号），导致界面昵称显示问题；后端需补齐或前端适配兼容。
- 统计接口返回 `postCount, likeCount, favoriteCount, followCount, fansCount`，不包含 `commentCount` 字段；前端取值需对齐实际返回。
- 管理后台服务监听端口：8888；避免与前端/后端端口冲突。
- 日志输出需简化，减少冗余/重复的 console 输出。
